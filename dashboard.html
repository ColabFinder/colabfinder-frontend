<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - ColabFinder</title>
</head>
<body>
  <h1>Welcome to the Dashboard</h1>
  <div id="user-info">
    <p><strong>Email:</strong> <span id="user-email"></span></p>
    <p><strong>User ID:</strong> <span id="user-id"></span></p>
  </div>

  <h2>Edit Profile</h2>
  <form id="profile-form">
    <label for="full_name">Full Name:</label><br/>
    <input type="text" id="full_name" name="full_name" /><br/><br/>

    <label for="bio">Bio:</label><br/>
    <textarea id="bio" name="bio" rows="4" cols="50"></textarea><br/><br/>

    <button type="submit">Update Profile</button>
  </form>

  <br/>
  <button id="logout">Logout</button>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://eqpmbcbaqdmrhwvlya.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcG1iY2JhcWdkbXJod212bHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NDg4ODQsImV4cCI6MjA2MDQyNDg4NH0.V3SwBCiBkGO_YxTKnE7jbdFthmXAJNbiEVcjsLUYCaM'
    const supabase = createClient(supabaseUrl, supabaseKey)

    async function getUserProfile() {
      const {
        data: { session },
        error: sessionError
      } = await supabase.auth.getSession()

      if (sessionError || !session) {
        window.location.href = 'index.html'
        return
      }

      const user = session.user
      document.getElementById('user-email').textContent = user.email
      document.getElementById('user-id').textContent = user.id

      // Load profile data from 'profiles' table
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('full_name, bio')
        .eq('id', user.id)
        .single()

      if (profile && !profileError) {
        document.getElementById('full_name').value = profile.full_name || ''
        document.getElementById('bio').value = profile.bio || ''
      }
    }

    async function updateUserProfile(event) {
      event.preventDefault()

      const fullName = document.getElementById('full_name').value
      const bio = document.getElementById('bio').value

      const {
        data: { user }
      } = await supabase.auth.getUser()

      const { error } = await supabase
        .from('profiles')
        .upsert({
          id: user.id,
          full_name: fullName,
          bio: bio
        })

      if (error) {
        alert('Error updating profile: ' + error.message)
      } else {
        alert('Profile updated!')
      }
    }

    document.getElementById('profile-form').addEventListener('submit', updateUserProfile)

    document.getElementById('logout').addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.href = 'index.html'
    })

    getUserProfile()
  </script>
</body>
</html>
