<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabaseUrl = 'https://eqpmbcbaqgdmrhwmvlya.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcG1iY2JhcWdkbXJod212bHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NDg4ODQsImV4cCI6MjA2MDQyNDg4NH0.V3SwBCiBkGO_YxTKnE7jbdFthmXAJNbiEVcjsLUYCaM'; // Replace with your actual key
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const userInfoDiv = document.getElementById('user-info');
  const formDiv = document.getElementById('profile-form');
  const profileDiv = document.getElementById('profile-data');

  async function loadDashboard() {
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
      window.location.href = 'index.html';
      return;
    }

    userInfoDiv.innerHTML = `
      <p><strong>Email:</strong> ${user.email}</p>
      <p><img src="${user.user_metadata.avatar_url}" width="80"/></p>
    `;

    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    if (error || !profile) {
      formDiv.classList.remove('hidden');
      document.getElementById('setup-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const full_name = document.getElementById('full_name').value;
        const platforms = document.getElementById('platforms').value;
        const followers = parseInt(document.getElementById('followers').value) || null;
        const collab_prefs = document.getElementById('collab_prefs').value;

        const { error: insertError } = await supabase.from('profiles').insert([
          {
            id: user.id,
            full_name,
            platforms,
            followers,
            collab_prefs
          }
        ]);

        if (insertError) {
          alert('Error saving profile: ' + insertError.message);
        } else {
          location.reload();
        }
      });
    } else {
      profileDiv.classList.remove('hidden');
      document.getElementById('name').textContent = profile.full_name;
      document.getElementById('platform-list').textContent = profile.platforms;
      document.getElementById('follower-count').textContent = profile.followers || 'N/A';
      document.getElementById('prefs').textContent = profile.collab_prefs;
    }
  }

  function logout() {
    supabase.auth.signOut().then(() => {
      window.location.href = 'index.html';
    });
  }

  loadDashboard();
</script>
