<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Profile</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Your Profile</h1>

  <div>
    <img id="avatar-img" src="https://placehold.co/80x80" alt="User Avatar" width="80" />
    <p><strong>Full Name</strong></p>
    <input type="text" id="full-name" placeholder="Enter full name" />
    <p><strong>Email</strong></p>
    <input type="email" id="email" disabled />
    <p><strong>Avatar URL</strong></p>
    <input type="text" id="avatar-url" placeholder="Enter avatar URL" />
    <br>
    <button id="save-btn">Save Profile</button>
    <button id="logout-btn">Logout</button>
  </div>

  <script>
    // ✅ Declare supabase outside so it's in global scope
    let supabase;

    document.addEventListener("DOMContentLoaded", async () => {
      // ✅ Initialize Supabase here
      const SUPABASE_URL = 'https://eqpmbcbaqgdmrhwmvlya.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcG1iY2JhcWdkbXJod212bHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NDg4ODQsImV4cCI6MjA2MDQyNDg4NH0.V3SwBCiBkGO_YxTKnE7jbdFthmXAJNbiEVcjsLUYCaM';
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const fullNameInput = document.getElementById('full-name');
      const emailInput = document.getElementById('email');
      const avatarUrlInput = document.getElementById('avatar-url');
      const avatarImg = document.getElementById('avatar-img');
      const saveBtn = document.getElementById('save-btn');
      const logoutBtn = document.getElementById('logout-btn');

      async function loadProfile() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        emailInput.value = user.email;

        const { data, error } = await supabase
          .from('profiles')
          .select('full_name, avatar_url')
          .eq('user_id', user.id);

        if (error) {
          console.error('Error fetching profile:', error.message);
          return;
        }

        if (!data || data.length === 0) {
          await supabase.from('profiles').insert({
            user_id: user.id,
            full_name: '',
            avatar_url: '',
            updated_at: new Date(),
            email: user.email
          });
          return loadProfile();
        }

        const profile = data[0];

        fullNameInput.value = profile.full_name || '';
        avatarUrlInput.value = profile.avatar_url || '';
        avatarImg.src = profile.avatar_url || 'https://placehold.co/80x80';
      }

      saveBtn.addEventListener('click', async () => {
        const { data: { user } } = await supabase.auth.getUser();

        const updates = {
          user_id: user.id,
          full_name: fullNameInput.value,
          avatar_url: avatarUrlInput.value,
          updated_at: new Date()
        };

        const { error } = await supabase.from('profiles').upsert(updates);

        if (error) {
          alert('Error saving profile: ' + error.message);
        } else {
          alert('Profile updated!');
          avatarImg.src = avatarUrlInput.value || 'https://placehold.co/80x80';
        }
      });

      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });

      await loadProfile();
    });
  </script>
</body>
</html>
