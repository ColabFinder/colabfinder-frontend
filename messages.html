<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8"><title>Messages – ColabFinder</title>
  <link rel="stylesheet" href="styles.css">
  <style>.thread{display:flex;align-items:center;margin:12px 0;}
         .thread img{width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:10px;}
  </style>
</head><body>
<div id="global-header"></div>

<h1>Messages</h1>
<div id="inbox"></div>

<script type="module" src="./supabaseClient.js"></script>
<script type="module" src="./header-loader.js"></script>
<script type="module">
import { supabase } from './supabaseClient.js';

const inbox = document.getElementById('inbox');
const { data:{session} } = await supabase.auth.getSession();
if(!session){ location.href='login.html'; throw ''; }
const myId = session.user.id;

/* 1. load last message per conversation */
const { data: threads, error } = await supabase
  .from('inbox')
  .select('*')
  .or(`sender_id.eq.${myId},recipient_id.eq.${myId}`)
  .order('created_at', { ascending:false });

if(error){ inbox.textContent='Error'; console.error(error); throw ''; }
if(!threads.length){ inbox.textContent='No messages yet'; }

/* 2. fetch profile data for all “other” users */
const otherIds = [...new Set(threads.map(t => 
  t.sender_id === myId ? t.recipient_id : t.sender_id ))];

const { data: profiles } = await supabase
  .from('profiles')
  .select('user_id,full_name,avatar_url')
  .in('user_id', otherIds);

const profMap = Object.fromEntries(profiles.map(p=>[p.user_id,p]));

/* 3. render inbox */
threads.forEach(t=>{
  const other = t.sender_id === myId ? t.recipient_id : t.sender_id;
  const profile = profMap[other] || {};
  const snippet = t.body.length>50 ? t.body.slice(0,50)+'…' : t.body;

  inbox.insertAdjacentHTML('beforeend',`
    <a class="thread" href="chat.html?u=${other}">
      <img src="${profile.avatar_url||'fallback-avatar.png'}">
      <div>
        <b>${profile.full_name||'Unknown'}</b><br>
        <small>${snippet}</small>
      </div>
    </a>`);
});
</script>
</body></html>
